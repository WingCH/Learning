# ğŸ¬ FFmpeg å‘½ä»¤è©³ç´°è§£é‡‹

## å‘½ä»¤

```bash
ffmpeg -i input.mp4 -c copy -movflags +faststart output.mp4
```

---

## ğŸ“‹ é€å€‹åƒæ•¸è§£é‡‹

### 1. `ffmpeg`

**é€™æ˜¯ä»€éº¼ï¼š** FFmpeg ç¨‹å¼æœ¬èº«

**ä½œç”¨ï¼š** 
- å¤šåª’é«”è™•ç†å·¥å…·
- å¯ä»¥è½‰æ›ã€ç·¨ç¢¼ã€è§£ç¢¼è¦–é »/éŸ³é »
- æ”¯æ´å¹¾ä¹æ‰€æœ‰æ ¼å¼

**é¡æ¯”ï¼š** å°±åƒ Photoshop ä¿‚è™•ç†åœ–ç‰‡ï¼ŒFFmpeg ä¿‚è™•ç†è¦–é »

---

### 2. `-i input.mp4`

**åƒæ•¸ï¼š** `-i` (input)

**ä½œç”¨ï¼š** æŒ‡å®š**è¼¸å…¥æ–‡ä»¶**

**ä¾‹å­ï¼š**
```bash
-i cannot_read_duration_in_android.mp4  # è®€å–é€™å€‹æ–‡ä»¶
```

**è§£é‡‹ï¼š**
- `-i` = inputï¼ˆè¼¸å…¥ï¼‰
- å‘Šè¨´ FFmpegï¼šã€Œå‘¢å€‹ä¿‚æˆ‘è¦è™•ç†å˜…æ–‡ä»¶ã€

---

### 3. `-c copy`

**åƒæ•¸ï¼š** `-c` (codec) + `copy`

**å®Œæ•´å¯«æ³•ï¼š** `-codec copy` æˆ– `-c:v copy -c:a copy`

**ä½œç”¨ï¼š** **è¤‡è£½** codecï¼Œ**ä¸é‡æ–°ç·¨ç¢¼**

#### ğŸ”‘ é€™æ˜¯æœ€é—œéµçš„åƒæ•¸ï¼

**å…©ç¨®æ¨¡å¼å°æ¯”ï¼š**

#### âŒ **é‡æ–°ç·¨ç¢¼æ¨¡å¼**ï¼ˆä¸ç”¨ `-c copy`ï¼‰
```bash
ffmpeg -i input.mp4 output.mp4  # æ²’æœ‰ -c copy
```

**æœƒç™¼ç”Ÿä»€éº¼ï¼š**
```
è¼¸å…¥ MP4
   â†“
è§£ç¢¼æˆåŸå§‹æ•¸æ“šï¼ˆYUV + PCMï¼‰
   â†“
é‡æ–°ç·¨ç¢¼ï¼ˆH.264 + AACï¼‰
   â†“
è¼¸å‡º MP4

æ™‚é–“ï¼šç´„ 5-10 åˆ†é˜ï¼ˆ50ç§’è¦–é »ï¼‰
è³ªé‡ï¼šå¯èƒ½æœ‰æå¤±
CPUï¼šé«˜è² è¼‰
```

#### âœ… **è¤‡è£½æ¨¡å¼**ï¼ˆç”¨ `-c copy`ï¼‰
```bash
ffmpeg -i input.mp4 -c copy output.mp4  # æœ‰ -c copy
```

**æœƒç™¼ç”Ÿä»€éº¼ï¼š**
```
è¼¸å…¥ MP4
   â†“
ç›´æ¥è¤‡è£½ H.264 è¦–é » stream
ç›´æ¥è¤‡è£½ AAC éŸ³é » stream
   â†“
é‡æ–°å°è£ container
   â†“
è¼¸å‡º MP4

æ™‚é–“ï¼šç´„ 3-5 ç§’ï¼ˆ50ç§’è¦–é »ï¼‰âœ…
è³ªé‡ï¼šå®Œå…¨ç„¡æ âœ…
CPUï¼šæ¥µä½è² è¼‰ âœ…
```

**é¡æ¯”ï¼š**
- **é‡æ–°ç·¨ç¢¼** = å½±å°ä¸€æœ¬æ›¸æ™‚ï¼Œé‡æ–°æ‰“å­—è¼¸å…¥ï¼ˆæ…¢ã€å¯èƒ½æœ‰éŒ¯ï¼‰
- **è¤‡è£½æ¨¡å¼** = å½±å°ä¸€æœ¬æ›¸æ™‚ï¼Œç›´æ¥å½±å°ï¼ˆå¿«ã€å®Œå…¨ä¸€æ¨£ï¼‰

---

### 4. `-movflags +faststart`

**åƒæ•¸ï¼š** `-movflags` (MOV format flags) + `+faststart`

**ä½œç”¨ï¼š** å°‡ **moov atom ç§»åˆ°æ–‡ä»¶é–‹é ­**

#### ğŸ“Š Before vs After

#### âŒ **æ²’æœ‰ faststart**
```
æ–‡ä»¶çµæ§‹ï¼š
[ftyp] - File type (å°)
[mdat] - Media data (å¤§ï¼Œ19 MB)
[moov] - Metadata (å°ï¼ŒåŒ…å« duration, tracks)
       â†‘
       åœ¨æœ€å¾Œï¼
```

**å•é¡Œï¼š**
- ä¸²æµæ’­æ”¾æ™‚ï¼Œéœ€è¦ä¸‹è¼‰æ•´å€‹æ–‡ä»¶æ‰èƒ½è®€åˆ° moov
- æ’­æ”¾å™¨è¦ç­‰ 19 MB ä¸‹è¼‰å®Œæ‰çŸ¥é“ duration
- ä¸èƒ½é‚Šä¸‹è¼‰é‚Šæ’­

#### âœ… **æœ‰ faststart**
```
æ–‡ä»¶çµæ§‹ï¼š
[ftyp] - File type (å°)
[moov] - Metadata (å°ï¼ŒåŒ…å« duration, tracks)
       â†‘
       ç§»åˆ°å‰é¢ï¼
[mdat] - Media data (å¤§ï¼Œ19 MB)
```

**å„ªé»ï¼š**
- æ’­æ”¾å™¨é¦¬ä¸Šè®€åˆ° moovï¼ˆduration, tracks ç­‰ï¼‰
- å¯ä»¥é‚Šä¸‹è¼‰é‚Šæ’­ âœ…
- Web æ’­æ”¾æ›´æµæš¢ âœ…
- Android æ’­æ”¾å™¨æ›´å¿«é–‹å§‹ âœ…

**é¡æ¯”ï¼š**
- **æ²’æœ‰ faststart** = æ›¸çš„ç›®éŒ„åœ¨æœ€å¾Œä¸€é ï¼ˆè¦ç¿»åˆ°æœ€å¾Œæ‰çŸ¥é“æœ‰ä»€éº¼å…§å®¹ï¼‰
- **æœ‰ faststart** = æ›¸çš„ç›®éŒ„åœ¨ç¬¬ä¸€é ï¼ˆä¸€æ‰“é–‹å°±çŸ¥é“å…§å®¹ï¼‰

---

### 5. `output.mp4`

**ä½œç”¨ï¼š** æŒ‡å®š**è¼¸å‡ºæ–‡ä»¶**åç¨±

**ä¾‹å­ï¼š**
```bash
cannot_read_duration_in_android_fixed.mp4  # è¼¸å‡ºåˆ°é€™å€‹æ–‡ä»¶
```

---

## ğŸ”¬ æ·±å…¥è§£é‡‹ï¼šé€™æ¢å‘½ä»¤åšäº†ä»€éº¼ï¼Ÿ

### Step by Step åŸ·è¡Œæµç¨‹

```bash
ffmpeg -i input.mp4 -c copy -movflags +faststart output.mp4
```

#### **Step 1: æ‰“é–‹è¼¸å…¥æ–‡ä»¶**
```
è®€å– input.mp4
åˆ†ææ–‡ä»¶çµæ§‹ï¼š
  âœ“ æ‰¾åˆ° ftyp (iso5) - Fragmented MP4
  âœ“ æ‰¾åˆ° moov (mvhd.duration = 0)
  âœ“ æ‰¾åˆ° mvex (Fragmented æ¨™è¨˜)
  âœ“ æ‰¾åˆ° 250 å€‹ moof atoms
  âœ“ æ‰¾åˆ° 250 å€‹ mdat atoms
  âœ“ åˆ†æè¦–é » stream: H.264, 1920x1080
  âœ“ åˆ†æéŸ³é » stream: AAC, 44100 Hz
```

#### **Step 2: éæ­·æ‰€æœ‰ fragmentsï¼Œè¨ˆç®—ç¸½ duration**
```
éæ­· moof atomsï¼š
  moof[1].duration = 0.200 ç§’
  moof[2].duration = 0.200 ç§’
  ...
  moof[250].duration = 0.200 ç§’
  
ç¸½ duration = 50.021222 ç§’ âœ…
```

#### **Step 3: é‡æ–°å°è£ï¼ˆå› ç‚ºæœ‰ -c copyï¼‰**
```
å‰µå»ºæ–°çš„ MP4 å®¹å™¨ï¼š
  âœ“ å¯«å…¥ ftyp: mp42 (å‚³çµ± MP4)
  âœ“ å‰µå»º moov atom
    - å¯«å…¥ mvhd: duration = 50022 âœ…
    - å¯«å…¥ trak (video)
    - å¯«å…¥ trak (audio)
    - ç§»é™¤ mvex âŒ (ä¸éœ€è¦äº†)
  âœ“ åˆä½µæ‰€æœ‰ mdat
    - è¤‡è£½ mdat[1] æ•¸æ“š
    - è¤‡è£½ mdat[2] æ•¸æ“š
    - ...
    - è¤‡è£½ mdat[250] æ•¸æ“š
    - å¯«æˆå–®ä¸€ mdat atom
```

#### **Step 4: æ‡‰ç”¨ faststartï¼ˆå› ç‚ºæœ‰ -movflags +faststartï¼‰**
```
æª¢æ¸¬åˆ° moov åœ¨ mdat å¾Œé¢
åŸ·è¡Œç¬¬äºŒæ¬¡è™•ç†ï¼š
  âœ“ è®€å–æ•´å€‹æ–‡ä»¶
  âœ“ å°‡ moov atom ç§»åˆ°é–‹é ­
  âœ“ èª¿æ•´æ‰€æœ‰ offset ä½ç½®
  âœ“ é‡å¯«æ–‡ä»¶
  
æœ€çµ‚çµæ§‹ï¼š
  [ftyp] mp42
  [moov] (duration = 50022) â† åœ¨é–‹é ­
  [mdat] (åˆä½µå¾Œçš„æ•¸æ“š)
```

#### **Step 5: å®Œæˆ**
```
è¼¸å‡ºçµ±è¨ˆï¼š
  âœ“ frame= 1250 (ç¸½å¹€æ•¸)
  âœ“ time=00:00:50.01 (ç¸½æ™‚é•·)
  âœ“ Lsize= 19643KiB (è¼¸å‡ºå¤§å°)
  âœ“ bitrate=3217.2kbits/s
  
âœ… è½‰æ›å®Œæˆï¼
```

---

## ğŸ’¡ ç‚ºä»€éº¼éœ€è¦é€™äº›åƒæ•¸ï¼Ÿ

### å¦‚æœä¸ç”¨ `-c copy` æœƒæ€æ¨£ï¼Ÿ

```bash
# æ²’æœ‰ -c copy
ffmpeg -i input.mp4 -movflags +faststart output.mp4
```

**æœƒç™¼ç”Ÿï¼š**
- âŒ é‡æ–°ç·¨ç¢¼è¦–é »ï¼ˆH.264 â†’ è§£ç¢¼ â†’ é‡æ–°ç·¨ç¢¼ H.264ï¼‰
- âŒ é‡æ–°ç·¨ç¢¼éŸ³é »ï¼ˆAAC â†’ è§£ç¢¼ â†’ é‡æ–°ç·¨ç¢¼ AACï¼‰
- âŒ è³ªé‡å¯èƒ½ä¸‹é™
- âŒ æ™‚é–“è®Šé•·ï¼ˆ5-10 åˆ†é˜ vs 3-5 ç§’ï¼‰
- âŒ CPU è² è¼‰é«˜

**å”¯ä¸€å„ªé»ï¼š**
- å¯ä»¥é †ä¾¿èª¿æ•´ç¢¼ç‡ã€è§£æåº¦ç­‰

---

### å¦‚æœä¸ç”¨ `-movflags +faststart` æœƒæ€æ¨£ï¼Ÿ

```bash
# æ²’æœ‰ -movflags +faststart
ffmpeg -i input.mp4 -c copy output.mp4
```

**æœƒç™¼ç”Ÿï¼š**
- âœ… è½‰æ›æˆåŠŸï¼Œä¿®å¾© Fragmented MP4 å•é¡Œ
- âœ… Android å¯ä»¥è®€å– duration
- âš ï¸ ä½† moov åœ¨æ–‡ä»¶æœ«å°¾

**å½±éŸ¿ï¼š**
- Web æ’­æ”¾ï¼šéœ€è¦ä¸‹è¼‰å®Œæ•´æ–‡ä»¶æ‰èƒ½é–‹å§‹æ’­æ”¾
- æœ¬åœ°æ’­æ”¾ï¼šæ²’å½±éŸ¿ï¼ˆå› ç‚ºå¯ä»¥ç›´æ¥ seek åˆ°æœ«å°¾ï¼‰
- ä¸²æµæ’­æ”¾ï¼šé«”é©—è¼ƒå·®

---

## ğŸ¯ å®Œæ•´åƒæ•¸çµ„åˆçš„æ„ç¾©

```bash
ffmpeg -i input.mp4 -c copy -movflags +faststart output.mp4
```

**é€™æ¢å‘½ä»¤åšäº†ï¼š**

1. âœ… **ä¿®å¾© Fragmented MP4** å•é¡Œ
   - ç§»é™¤ mvex
   - åˆä½µ moof/mdat
   - å¯«å…¥æ­£ç¢ºçš„ mvhd.duration

2. âœ… **ä¿æŒåŸå§‹è³ªé‡**ï¼ˆ`-c copy`ï¼‰
   - ä¸é‡æ–°ç·¨ç¢¼
   - ç„¡è³ªé‡æå¤±
   - å¿«é€Ÿè™•ç†

3. âœ… **å„ªåŒ–æ’­æ”¾é«”é©—**ï¼ˆ`-movflags +faststart`ï¼‰
   - moov åœ¨é–‹é ­
   - æ”¯æ´ä¸²æµæ’­æ”¾
   - å¿«é€Ÿé–‹å§‹æ’­æ”¾

---

## ğŸ“Š æ•¸æ“šå°æ¯”

### è¼¸å…¥æ–‡ä»¶ï¼ˆFragmented MP4ï¼‰
```
æ–‡ä»¶å¤§å°: 20,141,100 bytes (19.21 MB)
çµæ§‹:
  [ftyp] iso5                    32 bytes
  [moov]                      1,244 bytes
    [mvhd] duration = 0 âŒ
    [mvex] âš ï¸
  [moof] Ã— 250                ~75,000 bytes
  [mdat] Ã— 250            20,064,824 bytes
```

### è¼¸å‡ºæ–‡ä»¶ï¼ˆå‚³çµ± MP4ï¼‰
```
æ–‡ä»¶å¤§å°: 20,114,165 bytes (19.18 MB)
å·®ç•°: -26,935 bytes (-0.03 MB)

çµæ§‹:
  [ftyp] mp42                    32 bytes
  [moov]                     58,093 bytes â† è®Šå¤§äº†ï¼ˆåŒ…å«æ‰€æœ‰ metadataï¼‰
    [mvhd] duration = 50022 âœ…
    (ç„¡ mvex)
  [mdat]                 20,056,032 bytes â† å–®ä¸€ atom
```

**ç‚ºä»€éº¼è¼¸å‡ºåè€Œè®Šå°ï¼Ÿ**
- ç§»é™¤äº† 250 å€‹ moof atoms çš„é‡è¤‡ metadata
- åˆä½µæˆå–®ä¸€ mdatï¼Œæ¸›å°‘ atom headers

---

## ğŸ” æ›´æ·±å…¥ï¼šHex å±¤é¢çš„è®ŠåŒ–

### è¼¸å…¥æ–‡ä»¶é–‹é ­
```bash
$ xxd input.mp4 | head -5

00000000: 0000 001c 6674 7970 6973 6f35 0000 0200  ....ftypiso5....
                              ^^^^^ ^^^^
                              ftyp  iso5 â† Fragmented MP4

00000010: 6973 6f35 6973 6f36 6d70 3431 0000 04dc  iso5iso6mp41....
00000020: 6d6f 6f76 0000 006c 6d76 6864 0000 0000  moov...lmvhd....
00000030: 0000 0000 0000 0000 0000 03e8 0000 0000  ................
                                          ^^^^^^^^^
                                          duration = 0 âŒ
```

### è¼¸å‡ºæ–‡ä»¶é–‹é ­
```bash
$ xxd output.mp4 | head -5

00000000: 0000 0020 6674 7970 6973 6f6d 0000 0200  ... ftypisom....
                              ^^^^^ ^^^^
                              ftyp  isom/mp42 â† å‚³çµ± MP4

00000010: 6973 6f6d 6973 6f32 6176 6331 6d70 3431  isomiso2avc1mp41
00000020: 0000 e2ed 6d6f 6f76 0000 006c 6d76 6864  ....moov...lmvhd
00000030: 0000 0000 0000 0000 0000 0000 0000 03e8  ................
00000040: 0000 c366 0001 0000 0100 0000 0000 0000  ...f............
          ^^^^^^^^^
          duration = 50022 âœ…
```

---

## ğŸ“ é¡æ¯”ç¸½çµ

### æ•´å€‹éç¨‹åƒä»€éº¼ï¼Ÿ

**Fragmented MP4** = ä¸€æœ¬æ›¸è¢«æ’•æˆ 250 é ï¼Œæ•£è½ä¸€åœ°
- ç›®éŒ„é å¯«è‘—ï¼šã€Œç¸½é æ•¸ï¼šæœªçŸ¥ã€âŒ
- æ¯ä¸€é éƒ½æœ‰è‡ªå·±çš„é ç¢¼

**FFmpeg åšçš„äº‹ï¼š**
1. **æ”¶é›†æ‰€æœ‰é ** (è®€å– 250 å€‹ fragments)
2. **æ•¸é æ•¸** (è¨ˆç®—ç¸½ duration)
3. **é‡æ–°è£è¨‚** (åˆä½µæˆå–®ä¸€ mdat)
4. **æ›´æ–°ç›®éŒ„** (å¯«å…¥æ­£ç¢ºçš„ duration)
5. **ç›®éŒ„æ”¾å‰é¢** (faststart)

**çµæœ** = ä¸€æœ¬å®Œæ•´çš„æ›¸ âœ…
- ç›®éŒ„é å¯«è‘—ï¼šã€Œç¸½é æ•¸ï¼š250ã€âœ…
- æ‰€æœ‰å…§å®¹æŒ‰é †åºæ’åˆ—
- ä¸€ç¿»é–‹å°±çœ‹åˆ°ç›®éŒ„

---

## ğŸš€ å…¶ä»–å¸¸ç”¨è®Šé«”

### 1. åªä¿®å¾©ï¼Œä¸ faststart
```bash
ffmpeg -i input.mp4 -c copy output.mp4
```
é©ç”¨ï¼šæœ¬åœ°æ’­æ”¾ï¼Œä¸éœ€è¦ä¸²æµ

### 2. åŒæ™‚èª¿æ•´ç¢¼ç‡ï¼ˆæœƒé‡æ–°ç·¨ç¢¼ï¼‰
```bash
ffmpeg -i input.mp4 -b:v 2M -movflags +faststart output.mp4
```
é©ç”¨ï¼šéœ€è¦å£“ç¸®æª”æ¡ˆå¤§å°

### 3. æ‰¹é‡è™•ç†
```bash
for f in *.mp4; do
  ffmpeg -i "$f" -c copy -movflags +faststart "fixed_$f"
done
```

### 4. æª¢æŸ¥ä½†ä¸è½‰æ›
```bash
ffprobe -v error -show_format input.mp4
```

---

## ğŸ“ è¨˜æ†¶å£è¨£

```
ffmpeg        â†’ å·¥å…·åç¨±
-i            â†’ inputï¼ˆè¼¸å…¥æ–‡ä»¶ï¼‰
-c copy       â†’ codec copyï¼ˆè¤‡è£½ä¸ç·¨ç¢¼ = å¿«é€Ÿç„¡æï¼‰
-movflags +faststart â†’ moov å‰ç½®ï¼ˆå„ªåŒ–ä¸²æµï¼‰
output.mp4    â†’ è¼¸å‡ºæ–‡ä»¶
```

**ä¸€å¥è©±ï¼š** ç”¨ FFmpeg è¤‡è£½è¦–é » streamsï¼Œä¿®å¾©æ ¼å¼ï¼Œä¸¦æŠŠç›®éŒ„ï¼ˆmoovï¼‰æ”¾å‰é¢ã€‚

---

**ç¸½çµï¼š** é€™æ¢å‘½ä»¤å°±ä¿‚å°‡ Fragmented MP4 é‡æ–°åŒ…è£æˆå‚³çµ± MP4ï¼ŒåŒæ™‚ä¿æŒåŸå§‹è³ªé‡ï¼Œä»²å„ªåŒ–åŸ‹ä¸²æµæ’­æ”¾ï¼ğŸ¯

